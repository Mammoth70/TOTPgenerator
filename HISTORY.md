## История TOTPgenerator

Нумерация версий использует следующий формат:  

Major.Minor.Patch  

Major - крупные изменения и добавления, а также, изменения, которые делают приложения с разными Major версиями несовместимыми полностью или частично.
Minor - небольшие изменения, влияющие на ход выполнения приложения или на его интерфейс.
Patch - совсем незначительные изменения.  

Обычно, нумерация версий идёт по порядку.

### 1.0.0 - 1.0.1
Ранние версии. (Не выкладывались на github).

### 1.1.0
Первая версия, выложенная на github.

Добавлена защита входа PIN-кодом.  
Добавлены настройки: ввод, смена и удаление PIN-кода; направление движения индикатора прогресса.

### 1.1.1
Чтение из потока теперь делается без вызова фунции putData(), код теперь написан в лямбде.  

В файле build.gradle.kts обновлены версии библиотек и удалены неиспользуемые библиотеки.

### 1.1.2
Переименованы переменные и константы, константы перенесены между файлами. Изменено форматирование текста.

### 1.1.3
Удалены лишние переменные. Вместо конструкции "(if ... != null)" использованы "...?.let". 

### 1.2.0
Внесены изменения в функцию разбора QR-кода. Добавлено декодирование "процентных кодов", а в кодировке base32 разрешены символы нижнего регистра.

### 1.2.1
Метод adapter.notifyDataSetChanged() теперь вызывается при любом перестроении списка токенов.

### 1.2.2
Переименованы некоторые переменные.

### 1.3.0
Добавлен вход по биометрии.

### 1.4.0
Кнопка FAB "Добавить" удалена, вместо неё сделана кнопка меню в верхней панели.  

В макет и код SettingsActivity добавлен выбор режима темы "День", "Ночь" и "Системная".  

В макете SettingsActivity изменён вид кнопок "Назначить PIN" и "Удалить PIN".  

В списке токенов сделано пустое поле - футер для того, чтобы кнопка FAB не закрывала последнюю запись в списке.  

Теперь, пока приложение ещё остаётся в памяти, при повторном входе более не требуется ввод PIN-кода или проверка биометрии.  

Небольшой рефакторинг заголовка входа по биометрии.

### 1.4.1
В SettingsActivity удалена пустая нижняя панель и оптимизирован макет.  

Переименованы и перенесены между файлами некоторые константы.

### 1.4.2
Индикатор прогресса в режиме "осталось" теперь крутится по часовой стрелке.

### 1.4.3
Смена версии Gradle на 9.0.0.  

Переход на встроенный Kotlin.

### 1.4.4
Изменение года разработки приложения в файлах ресурсов strings.xml.

### 1.4.5
В классе TokensAdapter использованы конструкции "apply{}".

### 1.4.6
Смена версии Gradle на 9.3.0.  

Переход на AGP 9.0.0.  

Объявления зависимостей перенесены в файл libs.versions.toml.  

В файле gradle.properties удалены deprecated настройки.  

Выполнено уменьшение размера apk. Для этого включены соответствующие настройки в файле app/build.gradle.kts, добавлен файл res/raw/keep.xml.  

Отказ от конструкции "object: PopupMenu.OnMenuItemClickListener" при создании меню.  

Отказ от использования в файлах макетов атрибута "android:onClick". Вместо этого сделаны программные установки всех листенеров через setOnClickListener.  

Переписана функция копирования токена в буфер обмена. Учтены особенности разных версий Андроида. Добавлено сокрытие чувствительных данных.  
Добавлена очистка буфера обмена через 30 секунд.

### 1.4.7
В задержке очистки буфера обмена теперь используется конструкция "lifecycleScope.launch" вместо "Handler".  

Запрещено создание скриншотов экрана ввода PIN-кода, экрана со списком токенов и карточки токена.

### 1.4.8
Произведено переименование макетов.  
Для файлов переиспользуемых макетов (include) применяется префикс partial_. Для макета диалога - префикс dialog_.  

Изменения в файлах ресурсов.  
Из файлов с ресурсами меню удалены группы. Добавлено меню чтения QR-кода. Изменена прозрачность некоторых иконок.

### 1.5.0
Изменения в вводе, хранении и проверке PIN-кода.  
Вместо String теперь используется CharArray.  
PIN-код теперь хранится в виде криптографического хеша с использованием уникальной соли. Сам хеш перед сохранением дополнительно шифруется.  
Сразу после вычисления хеша CharArray затирается.  
Проверка выполняется путем сравнения хешей введённого и сохранённого PIN-кодов.

### 1.6.0
Вместо компонента ListView и адаптера ArrayAdapter теперь используется RecyclerView и ViewAdapter c использованием DiffUtil.

### 1.7.0
Изменения в классе TokensViewModel.  
Теперь, токены накапливаются в список, и делается один emit всего списка раз в секунду.  
Больше не используется и удалён глобальный список токенов appTokens.  

Изменения в классах данных секретов и токенов.  
Глобальный список секретов appSecrets перенесён из класса App в TokensViewModel.  
В OTPauth и Token удалены больше неиспользуемые поля num, а типы полей id сменены с Int на Long. (Хотя, вряд ли количество секретов превысит 2147483647).  

Изменения в передаче данных.  
Листенеры из адаптера теперь передают либо уникальный id-токена/секрета, либо строку с цифрами токена.  
Диалоговое окно секретов переделано для работы через id-токена.

### 1.7.1
Изменения в классе TokensViewModel.  
Массивы байтов секретов теперь подготавливаются из строк base32 заранее перед циклом генерации.  
Вызов генератора токенов обёрнут в блок "try catch". В случае ошибки генерации вместо токена выводится "------".  
Если список секретов пустой, то flow не выполняется до следующего вызова sendCommandUpdate.

### 1.8.0
Изменения в классе Token, а также в TokensViewModel, TokensAdapter.  
В макет и код SettingsActivity добавлен чекбокс для управления этой настройкой.  
Теперь можно дополнительно включить генерацию следующего за текущим токена.

### 1.8.1
Теперь TokensViewModel больше не перезапускается при смене флага генерации следующих токенов.  

Добавлены комментарии.

### 1.8.2
В файлах ресурсов разделители \r\n заменены на \n.

### 1.8.3
Изменения в модуле Parser.  
Добавлена функция isValidBase32 - расширенная проверка секрета Base32 на валидность.  
Переписана функция parseOTPauth. Вместо regexp применён разбор query-параметров, добавлена проверка на валидность секрета Base32.  

В форму ввода OTPauth тоже добавлена проверка секрета на валидность Base32.  

Модуль Prefs удалён.  
Вместо него добавлен объект SettingsManager. Туда перенесено всё управление переменными настроек и чтение/запись настроек из SharedPreferences.

### 1.8.4
Переписан TokensAdapter. Удален футер из кода, а в макет добавлены атрибуты "android:paddingBottom" и "android:clipToPadding", создающие и настраивающие внутренний отступ.

### 2.0.0
Переименованы модули и классы:
- модуль Parser переименован в OTPauthUriParser;
- модуль Secret переименован в SecurityCrypto;
- модуль SecretPin переименован в SecurityPin;
- класс AboutBox переименован в AboutDialog;
- класс PinBox переименован в PinDialog;
- класс SecretBox переименован в OTPauthDialog.  

Добавлены модульные и инструментальные тесты:
- модульный тест функции валидатора Base32 isValidBase32;
- модульный тест функции разбора схемы "otpauth:// parseOTPauth";
- модульный тест функции разбора схемы "otpauth-migration://" parseGoogleMigration;
- инструментальный тест работоспособности тестового окружения на устройстве;
- инструментальный тест цикла работы с PIN-кодом (хеширование с солью, шифрование и запись в хранилище, чтение, расшифровка, сравнение).  

Изменения в классе DBhelper:
- заменено использование конструкции ".use" для SQLiteDatabase на прямое обращение, чтобы избежать преждевременного закрытия глобального соединения;
- гарантировано закрытие курсоров через ".use";
- индексы колонок вынесены за пределы цикла while;
- map() заменён на any()/none();
- исправлена ошибка update по некорректному id.  

В функцию decodeOtpParameters (декодирования параметров OTP из потока CodedInputStream) встроена проверка на валидность секрета Base32.  

Чтобы было проще проходить модульные тесты была произведена замена библиотеки android.util.Base64 на java.util.Base64.  
Внесены соответствующие изменения в функции модулей OTPAuthUriParser и SecurityPin.  

Сменено имя файла SharedPreference, где хранится хеш PIN-кода. PIN-код нужно будет ввести в настройках заново. (перестраховка из-за смены библиотеки Base64).  

Внесены изменения в файлы ресурсов.  
Устранены неоднозначности в строках "key"/"secret" "ключ"/"секрет". Теперь используется "secret" и "секрет".

### 2.0.1
Класс PinBox действительно переименован в PinDialog.

### 2.0.2
Изменения в макетах. В файле activity_main.xml избавились от ConstraintLayout. Поправлен макет partial_fab_qr.xml, чтобы кнопка FAB могла взаимодействовать с CoordinatorLayout.  
Изменения в MainActivity. Все Snackbar теперь привязаны к кнопке FAB.

### 2.0.3
Создан модуль Util.  
В него перенесена функция isValidBase32 (проверка строки Base32 на валидность).  

Написаны функции логирования при включённом отладочном режиме.  
Добавлено логирование ошибок во все пустые блоки catch.  

### 2.1.0
Создан объект DataRepository. Объект отвечает за хранение в памяти и изменения списка секретов и за синхронизацию списка секретов с БД.  
Класс DBhelper переписан для работы с DataRepository. Вызовы DBhelper мимо DataRepository больше не применяются. Проверки из DBhelper перенесены в DataRepository.  
Все внешние вызовы фукций DBhelper сменены на вызовы функций DataRepository.  
Теперь функция обновления sendCommandUpdate() больше не перечитывает секреты из БД.

### 2.2.0
Добавлен сдвиг времени вперёд (от 0 до 5 секунд) при генерации токенов.  
Для этого в объект SettingsManager добавлена настройка timeShift.  
В макет и код SettingsActivity добавлен слайдер для управления этой настройкой.  
В класс TokensViewModel добавлен заданный сдвиг времени.  

В макете и коде SettingsActivity все чекбоксы заменены на переключатели. Поправлены некоторые листенеры.  

В объявления переменных объекта SettingsManager добавлены аннотации @Volatile.  

В классе PinDialog исправлены ошибки в последовательности вызовов clearAllPins и onPinResult.  

Переменная isHaveBiometric теперь инициализируется при объявлении вместо инициализации в классе App.  

Переменная isHaveHashPin теперь инициализируется при объявлении вместо инициализации в классе App.

### 2.2.1
Незначительные изменения объявлений листенеров в SettingsActivity.

### 2.3.0
Авторизация по биометрии, если она разрешена, включается сразу при открытии окна ввода PIN-кода.  
Для реализации этого в класс PinDialog внесены соответствующие изменения.  

В классе PinDialog вместо переменной mainContext теперь используется вызов requireActivity().  
Переменная mainContext удалена из MainActivity.  

Изменения в объекте SettingsManager.  
Теперь переменные с настройками записываются в SharedPreferences только при изменении текущего значения, а не при любом вызове сеттера.

### 2.4.0
Изменения в объекте SettingsManager.  
Теперь для настройки "Индикатор прогресса" назначено значение по умолчанию "осталось".  

Изменения в макете и коде класса PinDialog.  
Кнопки с цифрами сделаны покруглее, а расстояния между кнопками чуть побольше.  
Теперь при нажатии кнопки входа по биометрии очищается PIN-код и гасится строка сообщения об ошибке.  
Если пользователь отменил проверку биометрии кнопкой "отмена" или тапом вне области диалога, то сообщение об ошибке не выводится.

### 2.4.1
Изменения в макете и коде класса PinDialog.  
Цифры на кнопках стали покрупнее.  
В окне изменения или удаления PIN-кода поле errorMessage не показывается и не занимает место.

### 2.4.2
Изменения в макете MainActivity.  
В файле item_token.xml избавились от лишней вложенности, удалён FrameLayout.

### 2.4.3
Смена версии Gradle на 9.3.1.  
Обновлены объявления зависимостей в файле libs.versions.toml.

### 2.5.0
Переход на AGP 9.0.1.  

В файле gradle.properties сделана настройка android.nonTransitiveRClass=true.  
У функций showSnackbar, вызывающих ресурсы по ID, указаны аннотации @StringRes.  
У переменной idLayout в абстрактном классе AppActivity указана аннотация @LayoutRes.  
У переменной idActivity в абстрактном классе AppActivity указана аннотация @IdRes.  

Незначительные правки в макетах.  
Небольшие изменения в привязке выпадающих меню.

### 2.6.0
Произведено подключение к проекту ORM-библиотеки Room Persistence Library:
- обновлены объявления зависимостей в файле libs.versions.toml;
- в файле gradle.properties сделана настройка android.disallowKotlinSourceSets=false;
- внесены соответствующие изменения в файл build.gradle.kts проекта;
- внесены соответствующие изменения в файл build.gradle.kts приложения.  

Изменения в архитектуре.  
Произведён переход с SQLiteOpenHelper на Room:
- удалён класс DBhelper;
- добавлены интерфейс OTPauthDao, класс данных OTPauthEntity, абстрактный класс OTPauthDataBase;
- поправлен для работы с Room и перенесён в файл OTPauthEntity класс данных StringPair;
- объект DataRepository переименован в OTPauthDataRepo и переделан для работы с Room;
- все операции с БД в объекте OTPauthDataRepo переведены в потоки Dispatchers.IO;
- функции readAllSecrets, addSecret, editSecret и deleteSecret в объекте OTPauthDataRepo объявлены suspend;
- вызовы извне этих функций теперь обернуты в lifecycleScope.launch;
- сделана проверка успешного чтения БД, для этого в объект OTPauthDataRepo добавлены @Volatile переменные isDatabaseReady и databaseError.  

Изменения в базе данных.  
Произведена миграция схемы БД с версии 1 на версию 2, совместимую с Room:
- колонка step переименована в period в соответствии с названиями полей в классе данных OTPauth;
- исправлена ошибка: поле iv теперь получило явный тип TEXT;
- явно добавлены уникальные индексы для полей label и secret.  

Изменения в интерфейсе:
- диалоговые окна AboutDialog, PinDialog, OTPauthDialog переделаны в стиле Material3;
- добавлено диалоговое окно вывода критической ошибки базы данных;
- поправлен файл макета окна AboutDialog;
- удалён более не нужный файл styles.xml;
- изменения в строковых ресурсах.